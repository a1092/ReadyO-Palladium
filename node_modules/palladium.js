var util = require('util');
var logger = require('logger');
var EventEmitter = require('events').EventEmitter;


var Palladium = function (app) {

	EventEmitter.call(this);

	this.socket = null;
	this.application = app;
}

util.inherits(Palladium, EventEmitter);


Palladium.prototype.connect = function connect(server, cb) {
	
	var self = this;

	if(!server.host) {
		logger.error("Palladium host is missing in configuration.", { app: "palladium" });
		return;
	}

	if(!server.port) {
		logger.error("Palladium port is missing in configuration.", { app: "palladium" });
		return;
	}

	if(!this.application.privateKey) {
		logger.error("Palladium privateKey is missing in configuration.", { app: "palladium" });
		return;
	}

	if(!this.application.subscribtions) {
		logger.error("Palladium subscribtions is missing in configuration.", { app: "palladium" });
		return;
	}


	this.socket = require('socket.io-client')('http://'+server.host+':'+server.port);

	this.socket.on('connect', function(){

		self.send("fr/readyo/palladium/register", {
				privateKey: self.application.privateKey,
				subscribtions: self.application.subscribtions
		});

		logger.info("Connection to Palladium Server successful.", { app: "palladium" });

		if(typeof cb === 'function') {
			cb();
		}
	});

	this.socket.on('disconnect', function(){
		logger.error("The connection with Palladium Server was broken.", { app: "palladium" });
	});

	this.socket.on('error', function(error){
		logger.error("An error of connection happen with Palladium Server : "+error, { app: "palladium" });
	});

	var onevent = this.socket.onevent;
	this.socket.onevent = function(packet) {

		var args = packet.data || [];

		if (null != packet.id) args.push(self.socket.ack(packet.id));

		var topic = args[0];
		var data = args[1];

		if (self.socket.connected) {
			self.emit(topic, data);
		}

		onevent.apply(self.socket, arguments);
	};
}


Palladium.prototype.send = function(topic, data, reference) {
	
	this.socket.emit(topic, {
		data: data, 
		reference: reference
	});
}


module.exports = Palladium;