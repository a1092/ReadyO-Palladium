var util = require('util');
var logger = require('logger');
var EventEmitter = require('events').EventEmitter;
var WebSocket = require('ws');



var Palladium = function (serv, app) {

	EventEmitter.call(this);

	this.palladiumClient = null;
	this.palladiumServer = null;

	this.time2reconnect = 0;

	this.keepalive = parseInt(serv.keepalive);
	this.host = serv.host;
	this.port = serv.port;
	this.channel = serv.channel;
	this.privateKey = app.privateKey;
	this.subscribtions = app.subscribtions;
}

util.inherits(Palladium, EventEmitter);




Palladium.prototype.connect = function connect() {
	
	var self = this;

	palladiumServer = new WebSocket('ws://'+self.host+':'+self.port+'/'+self.channel);
	palladiumServer.binaryType = 'blob';

	palladiumServer.on('open', function() {

		self.time2reconnect = 0;

		self.send("fr/readyo/palladium/register", {
				privateKey: self.privateKey,
				subscribtions: self.subscribtions
		});

		logger.info("Connection to Palladium Server successful.", { app: "palladium" });
	});


	palladiumServer.on('close', function() {
		logger.error("The connection with Palladium Server was broken.", { app: "palladium" });
		self.reconnect();
	});

	palladiumServer.on('error', function(error) {
		logger.error("An error of connection happen with Palladium Server : "+error, { app: "palladium" });
		self.reconnect();
	});

	palladiumServer.on('message', function(incoming) {
		msg = JSON && JSON.parse(incoming) || $.parseJSON(incoming);
		self.emit(msg.topic, msg.data, msg.reference);
	});

	self.keepAlive();
}


Palladium.prototype.reconnect = function reconnect() {

	var self = this;

	if(self.time2reconnect < 120)
		self.time2reconnect += 10;

	logger.warn("Connection to Palladium Server in "+self.time2reconnect+" sec.", { app: "palladium" });

	setTimeout(function() {
		self.connect();
	}, self.time2reconnect*1000);
}

Palladium.prototype.send = function(topic, data, reference) {
	
	if(palladiumServer.readyState == WebSocket.OPEN)
		palladiumServer.send(JSON.stringify({
			reference: reference,
			topic: topic,
			data: data
		}));
}


Palladium.prototype.keepAlive = function() {
	
	var self = this;
	self.send("fr/readyo/palladium/system/keepalive", {});

	setTimeout(function() {
		self.keepAlive();
	}, self.keepalive*1000);
}


module.exports = Palladium;